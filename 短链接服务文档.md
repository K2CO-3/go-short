è¿™æ˜¯ä¸€ä»½ä¸ºæ‚¨é‡èº«å®šåˆ¶çš„**ã€ŠåŸºäº Go çš„åˆ†å¸ƒå¼å¾®æœåŠ¡çŸ­é“¾æ¥ç³»ç»Ÿ (GoShort) å¼€å‘å®æˆ˜æŒ‡å—ã€‹**ã€‚

è¿™ä»½æ–‡æ¡£ä¸¥æ ¼éµå¾ªæ‚¨çš„è¦æ±‚ï¼š**ä»£ç ç®€å•ã€æ¶æ„æ¸…æ™°ã€æ¨¡æ‹Ÿå¾®æœåŠ¡ã€é‡ç‚¹çªå‡ºç°ä»£åç«¯è®¾è®¡æ€æƒ³ï¼ˆé«˜å¹¶å‘ã€è¯»å†™åˆ†ç¦»ã€å¼‚æ­¥å¤„ç†ï¼‰**ã€‚æ–‡æ¡£ç»†èŠ‚å·²æ‹‰æ»¡ï¼Œå¯ä»¥ç›´æ¥ä½œä¸ºå¼€å‘æ‰‹å†Œä½¿ç”¨ã€‚

---

# é¡¹ç›®ä»£å·ï¼šGoShort (Microservice Short Link System)

## 1. ğŸ— é¡¹ç›®ç»“æ„è®¾è®¡ (Project Structure)

æœ¬é¡¹ç›®é‡‡ç”¨ **Monorepo (å•ä½“ä»“åº“)** ç®¡ç†ä»£ç ï¼Œä½†æ„å»ºå‡º **3 ä¸ªç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ (Microservices)**ã€‚è¿™ç§æ–¹å¼æ—¢æ–¹ä¾¿ä¸€ä¸ªäººå¼€å‘ç®¡ç†ï¼Œåˆèƒ½å®Œç¾æ¨¡æ‹Ÿå¾®æœåŠ¡æ¶æ„ã€‚

### æ ¸å¿ƒæœåŠ¡åˆ’åˆ†
1.  **Redirect Service (`cmd/redirect`)**: **é«˜æ€§èƒ½è¯»æœåŠ¡**ã€‚åªè´Ÿè´£ `Key-Value` æ˜ å°„æŸ¥å–å’Œ 302 è·³è½¬ï¼Œæ— é‰´æƒï¼Œæ— å¤æ‚ä¸šåŠ¡ï¼Œæµé‡æœ€å¤§ã€‚
2.  **API Service (`cmd/api`)**: **ä¸šåŠ¡é€»è¾‘å†™æœåŠ¡**ã€‚è´Ÿè´£ç”¨æˆ·ç®¡ç†ã€é“¾æ¥ç”Ÿæˆã€åå°ç®¡ç†ã€æƒé™æ ¡éªŒç­‰ã€‚
3.  **Worker Service (`cmd/worker`)**: **åå°å¼‚æ­¥æœåŠ¡**ã€‚è´Ÿè´£ä» Redis æ¶ˆè´¹è®¿é—®æ—¥å¿—å†™å…¥æ•°æ®åº“ã€æ¸…ç†è¿‡æœŸæ•°æ®ã€‚

### ç›®å½•æ ‘
```text
go-short/
â”œâ”€â”€ cmd/                          # é¡¹ç›®å…¥å£
â”‚   â”œâ”€â”€ api-server/               # [å¾®æœåŠ¡1] ç®¡ç†åå°API
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ redirect-server/          # [å¾®æœåŠ¡2] çŸ­é“¾è·³è½¬æ ¸å¿ƒ
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ worker/                   # [å¾®æœåŠ¡3] å¼‚æ­¥ä»»åŠ¡å¤„ç†
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶ (config.yaml)
â”œâ”€â”€ internal/                     # ç§æœ‰ä»£ç 
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Serviceå±‚)
â”‚   â”‚   â”œâ”€â”€ shortener.go          # Base62ç®—æ³•å®ç°
â”‚   â”‚   â””â”€â”€ token.go              # JWT å·¥å…·
â”‚   â”œâ”€â”€ data/                     # æ•°æ®è®¿é—®å±‚ (Repository)
â”‚   â”‚   â”œâ”€â”€ db.go                 # PostgreSQL åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ redis.go              # Redis åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ repository.go         # æ¥å£å®šä¹‰
â”‚   â”‚   â””â”€â”€ log_repository.go     # æ—¥å¿—ç›¸å…³æ“ä½œ
â”‚   â”‚   â””â”€â”€ user_repository.go    # ç”¨æˆ·ç›¸å…³æ“ä½œ
â”‚   â”‚   â””â”€â”€ link_repository.go    # é“¾æ¥ç›¸å…³æ“ä½œ
â”‚   â”œâ”€â”€ model/                    # æ•°æ®åº“æ¨¡å‹ (Struct)
â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â””â”€â”€ link.go
â”‚   â”‚   â””â”€â”€ accesslog.go
â”‚   â””â”€â”€ middleware/               # HTTP ä¸­é—´ä»¶ (Auth, CORS)
â”‚   â”‚   â”œâ”€â”€ cors.go               # CORS ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ auth.go               # Auth ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ admin.go              # admin ä¸­é—´ä»¶
â”œâ”€â”€ api/                          # Swagger/OpenAPI å®šä¹‰ (å¯é€‰)
â”œâ”€â”€ deploy/                       # éƒ¨ç½²ç›¸å…³
â”‚   â”œâ”€â”€ docker-compose.yml        # å®¹å™¨ç¼–æ’
â”‚   â”œâ”€â”€ Dockerfile.api            # API æœåŠ¡é•œåƒæ„å»º
â”‚   â”œâ”€â”€ Dockerfile.redirect       # è·³è½¬æœåŠ¡é•œåƒæ„å»º
â”‚   â””â”€â”€ Dockerfile.worker         # Worker æœåŠ¡é•œåƒæ„å»º
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

---

## 2. ğŸ’¾ æ•°æ®åº“è®¾è®¡ (Database Schema)

é€‰ç”¨ **PostgreSQL**ã€‚ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬å¯¹æ ¸å¿ƒå­—æ®µå»ºç«‹å¼ºç´¢å¼•ã€‚

### 2.1 Users è¡¨ (ç”¨æˆ·ä¸æƒé™)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(128),
    role VARCHAR(20) DEFAULT 'user',     -- 'admin' æˆ– 'user'
    status VARCHAR(20) DEFAULT 'active', -- 'active' æˆ– 'banned'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 Links è¡¨ (çŸ­é“¾æ¥æ ¸å¿ƒ)
```sql
CREATE TABLE links (
    id BIGSERIAL PRIMARY KEY,
    short_code VARCHAR(20) NOT NULL UNIQUE,  -- æ ¸å¿ƒç´¢å¼•ï¼šçŸ­ç 
    original_url TEXT NOT NULL,
    user_id BIGINT REFERENCES users(id),     -- å…³è”ç”¨æˆ·ï¼Œå¯ä¸ºç©º(åŒ¿åç”Ÿæˆ)
    is_custom BOOLEAN DEFAULT FALSE,         -- æ˜¯å¦è‡ªå®šä¹‰çŸ­ç 
    visit_count BIGINT DEFAULT 0,            -- æ€»è®¿é—®é‡ (å®šæœŸä»RedisåŒæ­¥æˆ–Workeræ›´æ–°)
    expires_at TIMESTAMP WITH TIME ZONE,     -- è¿‡æœŸæ—¶é—´ï¼ŒNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
    status BOOLEAN DEFAULT TRUE,             -- true: å¯ç”¨, false: ç¦ç”¨
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_links_user_id ON links(user_id);
CREATE INDEX idx_links_expires_at ON links(expires_at); -- ç”¨äºæ¸…ç†è¿‡æœŸä»»åŠ¡
```

### 2.3 AccessLogs è¡¨ (è®¿é—®æµæ°´ - å¤§æ•°æ®é‡)
æ­¤è¡¨å†™å…¥é‡å·¨å¤§ï¼Œä¸»è¦ç”± Worker å¼‚æ­¥å†™å…¥ã€‚
```sql
CREATE TABLE access_logs (
    id BIGSERIAL PRIMARY KEY,
    short_code VARCHAR(20) NOT NULL,
    ip_address VARCHAR(45),          -- æ”¯æŒ IPv6
    user_agent TEXT,
    referer TEXT,
    visited_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
-- ç»Ÿè®¡åˆ†æç´¢å¼•
CREATE INDEX idx_logs_code_time ON access_logs(short_code, visited_at);
```

---

## 3. ğŸ’» æ ¸å¿ƒä»£ç é€»è¾‘ (Core Logic)

ä¸ºäº†ä¿æŒâ€œç®€å•æ€§â€ï¼Œæˆ‘ä»¬ä½¿ç”¨ Gin (Webæ¡†æ¶) + GORM (ORM) + Go-Redisã€‚

### 3.1 Base62 ç®—æ³• (å·¥å…·ç±»)
ä¸ä½¿ç”¨ MD5 (å¤ªé•¿)ï¼Œä½¿ç”¨æ•°æ®åº“è‡ªå¢IDæˆ–åˆ†å¸ƒå¼IDç”Ÿæˆçš„æ•°å­—è¿›è¡Œ Base62 ç¼–ç ã€‚

```go
// internal/core/shortener.go
package core

import "strings"

const alphabet = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
const base = 62

// Encode å°† ID (å¦‚ 10001) è½¬æ¢ä¸º çŸ­ç  (å¦‚ "2Bh")
func Encode(num int64) string {
    if num == 0 {
        return "0"
    }
    var sb strings.Builder
    for num > 0 {
        rem := num % base
        sb.WriteByte(alphabet[rem])
        num = num / base
    }
    // ç¿»è½¬å­—ç¬¦ä¸²
    runes := []rune(sb.String())
    for i, j := 0, len(runes)-1; i < j; i, j = i+1, j-1 {
        runes[i], runes[j] = runes[j], runes[i]
    }
    return string(runes)
}
```

### 3.2 é«˜æ€§èƒ½é‡å®šå‘ (Redirect Service)
**è®¾è®¡æ€æƒ³**ï¼šä¼˜å…ˆæŸ¥ Redis -> æŸ¥ DB -> å†™å…¥ Redis ç¼“å­˜ -> å¼‚æ­¥å†™æ—¥å¿—ã€‚

```go
// cmd/redirect-server/main.go (ä¼ªä»£ç )

func RedirectHandler(c *gin.Context) {
    code := c.Param("code")
    ctx := context.Background()

    // 1. æŸ¥ Redis ç¼“å­˜
    cacheKey := "short:" + code
    longURL, err := redisClient.Get(ctx, cacheKey).Result()

    if err == redis.Nil {
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        var link model.Link
        if err := db.Where("short_code = ? AND status = ?", code, true).First(&link).Error; err != nil {
            c.JSON(404, gin.H{"error": "Link not found"})
            return
        }
        // 3. æ£€æŸ¥è¿‡æœŸ
        if link.ExpiresAt != nil && link.ExpiresAt.Before(time.Now()) {
             c.JSON(404, gin.H{"error": "Link expired"})
             return
        }
        longURL = link.OriginalURL
        // 4. å›å†™ Redis (è®¾ç½®1å°æ—¶è¿‡æœŸï¼Œé˜²æ­¢çƒ­ç‚¹æ•°æ®æ°¸ä¹…å ç”¨)
        redisClient.Set(ctx, cacheKey, longURL, time.Hour)
    }

    // 5. ã€å…³é”®ã€‘å¼‚æ­¥ç»Ÿè®¡ï¼šå°†è®¿é—®ä¿¡æ¯æ¨é€åˆ° Redis é˜Ÿåˆ—
    go func() {
        logData := map[string]interface{}{
            "code": code,
            "ip": c.ClientIP(),
            "ua": c.Request.UserAgent(),
            "ts": time.Now(),
        }
        // ä½¿ç”¨ List ç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—
        redisClient.RPush(ctx, "access_log_queue", json.Marshal(logData))
        // ç®€å•çš„è®¡æ•°å™¨ +1 (ç”¨äºå¿«é€Ÿå±•ç¤º)
        redisClient.Incr(ctx, "stats:count:" + code)
    }()

    // 6. 302 è·³è½¬
    c.Redirect(http.StatusFound, longURL)
}
```

### 3.3 å¼‚æ­¥æ¶ˆè´¹è€… (Worker Service)
**è®¾è®¡æ€æƒ³**ï¼šå‰Šå³°å¡«è°·ã€‚Redirect æœåŠ¡åªç®¡å‘ï¼ŒWorker æ…¢æ…¢å­˜ã€‚

```go
// cmd/worker/main.go (ä¼ªä»£ç )

func StartLogConsumer() {
    for {
        // é˜»å¡å¼è¯»å– Redis é˜Ÿåˆ—
        result, err := redisClient.BLPop(ctx, 0*time.Second, "access_log_queue").Result()
        if err != nil {
            continue
        }
        
        // è§£ææ—¥å¿—
        payload := result[1]
        var logEntry AccessLog
        json.Unmarshal([]byte(payload), &logEntry)

        // å†™å…¥ PostgreSQL
        // ä¼˜åŒ–ç‚¹ï¼šç”Ÿäº§ç¯å¢ƒé€šå¸¸ä¼šæ”’å¤Ÿ100æ¡å†æ‰¹é‡æ’å…¥ (Batch Insert)
        db.Create(&logEntry)
    }
}
```

---

## 4. ğŸ”Œ API æ¥å£å®šä¹‰ (è¯¦ç»†)

ç»Ÿä¸€å“åº”æ ¼å¼ï¼š
```json
{
  "code": 200,    // ä¸šåŠ¡çŠ¶æ€ç  (0: æˆåŠŸ, >0: é”™è¯¯)
  "msg": "success",
  "data": { ... } // æ•°æ®è½½è·
}
```

### 4.1 Redirect Service API
è¯¥æœåŠ¡ä¸éœ€è¦å‰ç¼€ `/api`ï¼Œç›´æ¥ç›‘å¬æ ¹è·¯å¾„ã€‚

#### `GET /{code}`
*   **æè¿°**: çŸ­é“¾æ¥è·³è½¬ã€‚
*   **Response**:
    *   302 Found: Header `Location: https://original.url...`
    *   404 Not Found: é¡µé¢æ˜¾ç¤ºâ€œé“¾æ¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸâ€ã€‚

---

### 4.2 API Service (ä¸šåŠ¡æ¥å£)
Base URL: `/api/v1`

#### ğŸ” Auth (è®¤è¯æ¨¡å—)

**1. æ³¨å†Œ (POST `/auth/register`)**
*   **Request**:
    ```json
    { "username": "tom", "password": "123", "email": "tom@ex.com" }
    ```
*   **Response**: `200 OK`

**2. ç™»å½• (POST `/auth/login`)**
*   **Request**:
    ```json
    { "username": "tom", "password": "123" }
    ```
*   **Response**:
    ```json
    {
      "token": "eyJhbGciOiJIUzI1Ni...", // JWT
      "expire_at": "2023-10-01T12:00:00Z"
    }
    ```

#### ğŸ”— Link (é“¾æ¥ç®¡ç†)
*éœ€ Header: `Authorization: Bearer <token>`*

**1. åˆ›å»ºçŸ­é“¾æ¥ (POST `/links`)**
*   **Request**:
    ```json
    {
      "url": "https://google.com/very/long/url",
      "custom_code": "myGoogle", // å¯é€‰
      "expire_in_hours": 24      // å¯é€‰ï¼Œ0ä¸ºæ°¸ä¹…
    }
    ```
*   **Response**:
    ```json
    {
      "short_url": "http://localhost/myGoogle",
      "short_code": "myGoogle"
    }
    ```

**2. è·å–æˆ‘çš„é“¾æ¥åˆ—è¡¨ (GET `/links`)**
*   **Params**: `page=1`, `size=10`
*   **Response**:
    ```json
    {
      "total": 50,
      "list": [
        {
          "id": 100,
          "short_code": "abc",
          "original_url": "...",
          "visit_count": 120, // ç»“åˆ Redis å’Œ DB çš„æ•°æ®
          "created_at": "..."
        }
      ]
    }
    ```

**3. æ›´æ–°é“¾æ¥ (PUT `/links/{id}`)**
*   **Request**:
    ```json
    {
      "status": false, // æš‚åœé“¾æ¥
      "new_url": "https://new-url.com", // ä¿®æ”¹åŸé“¾æ¥
      "expire_at": "2024-01-01T00:00:00Z" // ä¿®æ”¹æœ‰æ•ˆæœŸ
    }
    ```

**4. åˆ é™¤é“¾æ¥ (DELETE `/links/{id}`)**
*   **Logic**: è½¯åˆ é™¤æ•°æ®åº“ + åˆ é™¤ Redis ç¼“å­˜ã€‚

#### ğŸ›¡ Admin (ç®¡ç†å‘˜æ¨¡å—)
*éœ€æ£€æŸ¥ç”¨æˆ· Role ä¸º `admin`*

**1. ç³»ç»Ÿå¤§ç›˜ (GET `/admin/stats`)**
*   **Response**:
    ```json
    {
      "total_links": 10000,
      "total_visits": 500000,
      "today_visits": 200,
      "service_health": "good" // åŸºäº Redis Ping ç»“æœ
    }
    ```

**2. ç”¨æˆ·ç®¡ç† (GET `/admin/users`)**
*   **Params**: `page=1`, `size=20`
*   **Response**: ç”¨æˆ·åˆ—è¡¨ï¼ŒåŒ…å«ç¦ç”¨/å¯ç”¨æŒ‰é’®æ‰€éœ€çš„çŠ¶æ€ã€‚

**3. å°ç¦ç”¨æˆ· (POST `/admin/users/{id}/ban`)**
*   **Logic**: æ›´æ–° users è¡¨ statusï¼Œå¹¶å°†è¯¥ç”¨æˆ·æ‰€æœ‰ links è®¾ä¸ºç¦ç”¨ã€‚

---

## 5. ğŸš€ å¼€å‘æ­¥éª¤è§„åˆ’ (MVP Roadmap)

æ•´ä¸ªå¼€å‘å‘¨æœŸçº¦ä¸º 5-7 å¤©ï¼Œæ³¨é‡ MVP (Minimum Viable Product)ã€‚

### Phase 1: åŸºç¡€è®¾æ–½ä¸æ ¸å¿ƒæ•°æ®å±‚ (Day 1)
1.  **Init**: `go mod init go-short`ã€‚
2.  **Docker**: ç¼–å†™ `docker-compose.yml`ï¼Œå¯åŠ¨ PostgreSQL å’Œ Redisã€‚
3.  **Model**: ä½¿ç”¨ GORM å®šä¹‰ User å’Œ Link ç»“æ„ä½“ï¼Œè¿è¡Œ AutoMigrate ç”Ÿæˆè¡¨ã€‚
4.  **Test**: ç¼–å†™ä¸€ä¸ªç®€å•çš„ Go è„šæœ¬ï¼Œæµ‹è¯•è¿æ¥ DB å’Œ Redis æ˜¯å¦æˆåŠŸã€‚

### Phase 2: æ ¸å¿ƒä¸šåŠ¡ - ç”Ÿæˆä¸è·³è½¬ (Day 2)
1.  **Base62**: å®ç° ID è½¬çŸ­ç å·¥å…·ã€‚
2.  **Redirect Service**:
    *   å®ç° `/ :code` æ¥å£ã€‚
    *   å®ç°â€œæŸ¥Redis -> æŸ¥DB -> 302â€é€»è¾‘ã€‚
    *   æš‚æ—¶ä¸å†™æ—¥å¿—ï¼Œå…ˆè·‘é€šè·³è½¬ã€‚
3.  **API Service**:
    *   å®ç°â€œåˆ›å»ºé“¾æ¥â€æ¥å£ (åŒ¿ååˆ›å»ºï¼Œæš‚ä¸åŠ é‰´æƒ)ã€‚

### Phase 3: è®¤è¯ä¸ç®¡ç†åŠŸèƒ½ (Day 3-4)
1.  **JWT**: å®ç° `GenerateToken` å’Œ `AuthMiddleware`ã€‚
2.  **User API**: å®Œæˆæ³¨å†Œã€ç™»å½•æ¥å£ã€‚
3.  **Link API**: å°†â€œåˆ›å»ºé“¾æ¥â€æ”¹ä¸ºéœ€ç™»å½•ï¼Œå¢åŠ â€œæˆ‘çš„åˆ—è¡¨â€ã€â€œåˆ é™¤â€æ¥å£ã€‚
4.  **Refactor**: å°† API Service å’Œ Redirect Service å½»åº•åˆ†å®¶ï¼ˆç›‘å¬ä¸åŒç«¯å£ï¼‰ã€‚

### Phase 4: é«˜å¯ç”¨ç»„ä»¶ - å¼‚æ­¥æ—¥å¿—ä¸ç¼“å­˜ (Day 5)
1.  **Async**: åœ¨ Redirect Service è·³è½¬å‰ï¼Œ`RPush` æ—¥å¿—åˆ° Redisã€‚
2.  **Worker**: åˆ›å»º `cmd/worker`ï¼Œå®ç° `BLPop` å¾ªç¯ï¼Œå°†æ—¥å¿—å…¥åº“ã€‚
3.  **Stats**: å®ç°ç®€å•çš„ç»Ÿè®¡æ¥å£ï¼Œè¯»å– Redis ä¸­çš„è®¡æ•°å™¨ã€‚

### Phase 5: å‰ç«¯ä¸å®¹å™¨åŒ–éƒ¨ç½² (Day 6)
1.  **Frontend**: ç”¨ React/Vue å¿«é€Ÿç”»ä¸‰ä¸ªé¡µé¢ï¼ˆç™»å½•ã€ç”Ÿæˆå™¨ã€åˆ—è¡¨ï¼‰ã€‚
2.  **Dockerize**:
    *   ç¼–å†™ 3 ä¸ª Dockerfileã€‚
    *   æ›´æ–° `docker-compose.yml`ï¼Œä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ (App * 3 + DB + Redis)ã€‚
3.  **Docs**: æˆªå›¾ã€å†™ READMEã€‚

### éƒ¨ç½²ç¤ºæ„ (docker-compose.yml ç‰‡æ®µ)

```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_PASSWORD: root
  redis:
    image: redis:alpine
  
  # æ ¸å¿ƒè·³è½¬æœåŠ¡ (æ¨¡æ‹Ÿéƒ¨ç½²2ä¸ªå®ä¾‹åšè´Ÿè½½å‡è¡¡)
  redirect-service:
    build: 
      context: .
      dockerfile: deploy/Dockerfile.redirect
    ports:
      - "80:8080" # å¯¹å¤–æš´éœ²80ç«¯å£
    depends_on:
      - redis
      - postgres
    environment:
      - DB_HOST=postgres
      - REDIS_ADDR=redis:6379

  # ç®¡ç†åå° API
  api-service:
    build:
      context: .
      dockerfile: deploy/Dockerfile.api
    ports:
      - "8081:8081"
    
  # å¼‚æ­¥ Worker
  worker-service:
    build:
      context: .
      dockerfile: deploy/Dockerfile.worker
    # ä¸éœ€è¦ Portsï¼Œå› ä¸ºå®ƒæ˜¯åå°æ¶ˆè´¹
```

---

### é¢è¯•å®˜é—®ç­”é¢„æ¼” (Bonus)

*   **Q: ä¸ºä»€ä¹ˆæŠŠé‡å®šå‘å’ŒAPIæ‹†å¼€ï¼Ÿ**
    *   A: é‡å®šå‘æ˜¯**è¯»å¤šå†™å°‘**ï¼Œè¦æ±‚æè‡´ä½å»¶è¿Ÿï¼›APIæ˜¯**ä¸šåŠ¡å¤æ‚**ã€‚æ‹†å¼€åï¼Œæˆ‘å¯ä»¥å•ç‹¬ç»™é‡å®šå‘æœåŠ¡æ‰©å®¹ï¼ˆä¾‹å¦‚éƒ¨ç½²10ä¸ªRedirectå®¹å™¨ï¼Œä½†åªéœ€1ä¸ªAPIå®¹å™¨ï¼‰ï¼ŒèŠ‚çœèµ„æºä¸”äº’ä¸å½±å“ã€‚
*   **Q: å¦‚æœ Redis æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ**
    *   A: ä»£ç ä¸­åšäº†é™çº§å¤„ç†ã€‚`redis.Get` è¿”å› error æ—¶ï¼Œä¼šç©¿é€æŸ¥è¯¢æ•°æ®åº“ã€‚è™½ç„¶ä¼šå¢åŠ æ•°æ®åº“å‹åŠ›ï¼Œä½†ä¿è¯äº†æœåŠ¡å¯ç”¨æ€§ã€‚
*   **Q: çŸ­ç å¦‚ä½•ä¿è¯å”¯ä¸€ï¼Ÿ**
    *   A: æˆ‘åˆ©ç”¨äº† Postgres çš„è‡ªå¢ ID (æˆ– Sequence) + Base62 ç¼–ç ã€‚å› ä¸º ID æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œæ‰€ä»¥ç¼–ç åçš„çŸ­ç ä¹Ÿæ˜¯å”¯ä¸€çš„ã€‚å¯¹äºè‡ªå®šä¹‰çŸ­ç ï¼Œåˆ©ç”¨äº†æ•°æ®åº“çš„ `UNIQUE` ç´¢å¼•çº¦æŸã€‚

è¯·åŸºäºæ­¤æ–‡æ¡£å¼€å§‹æ‚¨çš„å¼€å‘ã€‚å¦‚æœ‰å…·ä½“çš„ä»£ç å®ç°ç»†èŠ‚å¡ä½äº†ï¼Œå¯ä»¥éšæ—¶å°†è¯¥æ¨¡å—çš„ä»£ç å‘ç»™æˆ‘è¿›è¡Œ Debugã€‚